version: 2

models:
  - name: stg_orders
    description: >
      Staging model for order fact table.
      One row per order with customer, store, and financial details.
      Monetary values have been converted from cents to dollars.
    data_tests:
      - column_sum_equals:
          arguments:
            column_1: subtotal
            column_2: tax_paid
            sum_column: order_total
            tolerance: 0.01
    columns:
      - name: order_id
        description: Unique identifier for each order (primary key)
        data_tests:
          - unique
          - not_null

      - name: customer_id
        description: Foreign key to customers
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_customers')
                field: customer_id
      - name: store_id
        description: Foreign key to stores
        data_tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_stores')
                field: store_id
      - name: ordered_at
        description: Timestamp when the order was placed
        data_tests:
          - not_null
          # dbt-expectations: Ensure dates are not in the future
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: "cast('2015-01-01' as timestamp)"
                max_value: "current_timestamp()"
              config:
                severity: error
          # dbt-expectations: Check for recent data (data freshness)
          - dbt_expectations.expect_row_values_to_have_recent_data:
              arguments:
                datepart: day
                interval: 7
              config:
                severity: warn

      - name: subtotal
        description: Order subtotal in dollars (before tax)
        data_tests:
          - not_null
          # dbt-expectations: Validate subtotal is within realistic range
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 0.01
                max_value: 1000
              config:
                severity: warn

      - name: tax_paid
        description: Tax amount in dollars
        data_tests:
          - not_null

      - name: order_total
        description: Total order amount in dollars (subtotal + tax)
        data_tests:
          - not_null

      - name: tax_rate
        description: Calculated tax rate (tax_paid / subtotal) for validation
        data_tests:
          # dbt-expectations: Validate tax rate is realistic (0-20%)
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 0
                max_value: 0.20
                row_condition: "subtotal > 0"
              config:
                severity: warn

      - name: _loaded_at
        description: Timestamp when this record was loaded into staging
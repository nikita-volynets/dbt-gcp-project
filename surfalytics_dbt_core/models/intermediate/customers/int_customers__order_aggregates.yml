version: 2

unit_tests:
  - name: test_customer_order_aggregates
    description: "Test that customer order aggregates are calculated correctly"
    model: int_customers__order_aggregates
    given:
      - input: ref('int_orders__joined')
        rows:
          - customer_id: 1
            order_id: 100
            ordered_at: '2024-01-01 10:00:00'
            order_total: 50.00
          - customer_id: 1
            order_id: 101
            ordered_at: '2024-01-15 14:30:00'
            order_total: 75.00
          - customer_id: 2
            order_id: 102
            ordered_at: '2024-01-10 09:00:00'
            order_total: 100.00
      - input: ref('stg_order_items')
        rows:
          - order_id: 100
          - order_id: 100
          - order_id: 101
          - order_id: 101
          - order_id: 101
          - order_id: 102
    expect:
      rows:
        - customer_id: 1
          first_order_at: '2024-01-01 10:00:00'
          most_recent_order_at: '2024-01-15 14:30:00'
          total_orders: 2
          total_revenue: 125.00
          total_items_purchased: 5
          avg_order_value: 62.50
          avg_items_per_order: 2.5
          customer_lifetime_days: 14
        - customer_id: 2
          first_order_at: '2024-01-10 09:00:00'
          most_recent_order_at: '2024-01-10 09:00:00'
          total_orders: 1
          total_revenue: 100.00
          total_items_purchased: 1
          avg_order_value: 100.00
          avg_items_per_order: 1.0
          customer_lifetime_days: 0

models:
  - name: int_customers__order_aggregates
    description: >
      Customer-level order behavior aggregates.
      One row per customer with summary statistics of their ordering history.
      Foundation for customer analytics and segmentation.
    columns:
      - name: customer_id
        description: Unique customer identifier (primary key)
        data_tests:
          - unique
          - not_null

      - name: first_order_at
        description: Timestamp of customer's first order

      - name: most_recent_order_at
        description: Timestamp of customer's most recent order

      - name: total_orders
        description: Total number of orders placed by this customer
        data_tests:
          - not_null
          # dbt-utils: Ensure order count is positive
          - dbt_utils.expression_is_true:
              arguments:
                expression: "> 0"
              config:
                severity: error

      - name: total_revenue
        description: Total revenue generated by this customer (sum of all order totals)
        data_tests:
          - not_null
          # dbt-utils: Ensure revenue is non-negative
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"
              config:
                severity: error

      - name: total_items_purchased
        description: Total number of items purchased across all orders

      - name: avg_order_value
        description: Average order total for this customer

      - name: avg_items_per_order
        description: Average number of items per order

      - name: customer_lifetime_days
        description: Days between first and most recent order
        data_tests:
          - not_null
          # dbt-utils: Ensure lifetime is non-negative
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"
              config:
                severity: error

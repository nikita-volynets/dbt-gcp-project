version: 2

models:
  - name: customers
    description: >
      **Customer Dimension Table**

      The definitive customer dimension combining profile data with behavioral metrics
      and customer segmentation. This is the primary table for customer analytics.

      **Grain**: One row per customer

      **Use Cases**:
      - Customer segmentation and targeting
      - Identifying high-value customers
      - Churn analysis and retention monitoring
      - Customer behavior analysis
    data_tests:
      # dbt-expectations: Table-level row count validation
      - dbt_expectations.expect_table_row_count_to_be_between:
          arguments:
            min_value: 1
            max_value: 1000000
          config:
            severity: error
      # dbt-expectations: Schema completeness check
      - dbt_expectations.expect_table_columns_to_contain_set:
          arguments:
            column_list:
              - customer_id
              - customer_name
              - total_orders
              - total_revenue
              - customer_segment
          config:
            severity: error
    columns:
      - name: customer_id
        description: Unique customer identifier (primary key)
        data_tests:
          - unique
          - not_null

      - name: customer_name
        description: Customer full name

      - name: first_order_at
        description: Timestamp of customer's first order

      - name: most_recent_order_at
        description: Timestamp of customer's most recent order

      - name: total_orders
        description: Lifetime number of orders placed by this customer
        data_tests:
          # dbt-expectations: Statistical distribution check (95th percentile)
          - dbt_expectations.expect_column_quantile_values_to_be_between:
              arguments:
                quantile: 0.95
                min_value: 0
                max_value: 50
              config:
                severity: warn

      - name: total_revenue
        description: Lifetime revenue generated by this customer
        data_tests:
          # dbt-expectations: Ensure revenue is non-negative
          - dbt_expectations.expect_column_values_to_be_between:
              arguments:
                min_value: 0
                strictly: false
              config:
                severity: error

      - name: total_items_purchased
        description: Lifetime count of items purchased

      - name: avg_order_value
        description: Average order value across all customer orders

      - name: avg_items_per_order
        description: Average number of items per order

      - name: customer_lifetime_days
        description: Days between first and most recent order

      - name: cohort_month
        description: Month cohort (first day of month) based on first order date

      - name: cohort_quarter
        description: Quarter cohort (first day of quarter) based on first order date

      - name: cohort_year
        description: Year cohort based on first order date

      - name: customer_segment
        description: >
          Customer value segmentation based on order behavior.
          High Value: 100+ orders OR $10,000+ revenue;
          Medium Value: 20+ orders OR $2,000+ revenue;
          Low Value: all others
        data_tests:
          # dbt-expectations: Validate exactly 3 distinct segments exist
          - dbt_expectations.expect_column_distinct_count_to_equal:
              arguments:
                value: 3
              config:
                severity: warn

      - name: is_active
        description: Boolean flag - true if customer ordered in last 90 days
        data_tests:
          # dbt-expectations: Validate boolean values
          - dbt_expectations.expect_column_values_to_be_in_set:
              arguments:
                value_set: ['true', 'false']
                quote_values: false
              config:
                severity: error

      - name: is_churned
        description: Boolean flag - true if customer has not ordered in 180+ days
        data_tests:
          # dbt-expectations: Validate boolean values
          - dbt_expectations.expect_column_values_to_be_in_set:
              arguments:
                value_set: ['true', 'false']
                quote_values: false
              config:
                severity: error
    config:
      meta:
        owner: analytics
        domain: customer_analytics